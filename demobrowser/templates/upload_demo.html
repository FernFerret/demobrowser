{% extends "layout-fixed.html" %}
{% block main %}
<form action="{{ url_for('upload_demo') }}" method="POST" enctype="multipart/form-data">
  <fieldset>
    <legend><h3>Upload a Demo</h3></legend>
    <div>
      <h4>About Demo Uploads</h2>
      <p>The filename of the demo is used to determine the <strong>map</strong> and <strong>date</strong>. The accepted syntax is the same as your Team Fortress 2 server creates the demos. If you keep getting an error, see the <a href="{{ url_for('static', filename='img/anatomy_demo_file.png')}}">anatomy of a demo filename</a> for more info!</p>
      {#<img src="{{ url_for('static', filename='img/anatomy_demo_file.png')}}" />#}
    </div>
    <div class="row-fluid">
      <div id="drop_zone_demo" class=" span6 upload_box">
        <h2>Drop <span style="color:#FF8540;">demo</span> file here!</h2>
      </div>
      <div id="drop_zone_log" class="span6 upload_box">
        <h2>Drop <span style="color:#4284D3;">log</span> file here!</h2>
      </div>
    </div>
    <div class="row-fluid">
      <div class="progress progress-striped active span6">
          <div class="bar" style="width: 40%;"></div>
      </div>
      <div class="progress progress-striped active span6">
         <div class="bar" style="width: 40%;"></div>
      </div>
    </div>
    {#
    <div class="control-group  {% if 'name' in errors %}error{% endif %}">
      <label class="control-label" for="Íname">Demo File</label>
      <div class="controls">
        <input type="file" class="input-xlarge" id="demo_file" name="demo_file" placeholder="auto-19880905-XXXX-cp_gravelpit.dem" value="{{ values.get('name', '') }}"/>
      </div>
    </div>
    <div class="control-group  {% if 'name' in errors %}error{% endif %}">
      <label class="control-label" for="Íname">Log File</label>
      <div class="controls">
        <input type="file" class="input-xlarge" id="log_file" name="log_file" placeholder="auto-19880905-XXXX-cp_gravelpit.dem" value="{{ values.get('name', '') }}"/>
      </div>
    </div>
    #}
    <div style="text-align:center;" class="form-actions">
      <button type="submit" class="btn btn-success">Upload Demo</button>
    </div>
  </fieldset>
</form>
{% endblock %}
{% block javascript %}
<script>
function handleFileSelectDemo(evt) {
  evt.stopPropagation();
  evt.preventDefault();

  var files = evt.dataTransfer.files; // FileList object.

  // files is a FileList of File objects. List some properties.
  var output = [];
  for (var i = 0, f; f = files[i]; i++) {
    var fn = escape(f.name);
    var name_match = fn.match(/^auto-([0-9]{8})-.*-(.*)\.dem$/);
    if (name_match == null) {
      output.push('<h3 style="color:#BE2F33;">', escape(f.name), '</h3>');
    } else {
      output.push('<h3 style="color:#2D9B27;">', escape(f.name), '</h3>');
    }

    console.log(name_match);

  }
  document.getElementById('drop_zone_demo').innerHTML = output.join('');
}
  function handleFileSelectLog(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object.

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      var fn = escape(f.name);
      var name_match = fn.match(/^.*\.log$/);
      if (name_match == null) {
        output.push('<h3 style="color:#BE2F33;">', escape(f.name), '</h3>');
      } else {
        output.push('<h3 style="color:#2D9B27;">', escape(f.name), '</h3>');
      }
    }
    document.getElementById('drop_zone_log').innerHTML = output.join('');
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }

  // Setup the dnd listeners.
  var dropZoneDemo = document.getElementById('drop_zone_demo');
  dropZoneDemo.addEventListener('dragover', handleDragOver, false);
  dropZoneDemo.addEventListener('drop', handleFileSelectDemo, false);
  var dropZoneLog = document.getElementById('drop_zone_log');
  dropZoneLog.addEventListener('dragover', handleDragOver, false);
  dropZoneLog.addEventListener('drop', handleFileSelectLog, false);
</script>
{% endblock %}
