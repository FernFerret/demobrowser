{% extends "layout-fixed.html" %}
{% block main %}
<form action="{{ url_for('upload_demo') }}" method="POST" enctype="multipart/form-data">
  <fieldset>
    <legend><h3>Upload a Demo</h3></legend>
    <div>
      <h4>About Demo Uploads</h2>
      <p>The filename of the demo is used to determine the <strong>map</strong> and <strong>date</strong>. The accepted syntax is the same as your Team Fortress 2 server creates the demos. If you keep getting an error, see the <a href="{{ url_for('static', filename='img/anatomy_demo_file.png')}}">anatomy of a demo filename</a> for more info!</p>
      {#<img src="{{ url_for('static', filename='img/anatomy_demo_file.png')}}" />#}
    </div>
    <div class="row-fluid">
      <div id="drop_zone_demo" class=" span6 upload_box">
        <h2>Drop <span style="color:#FF8540;">demo</span> file here!</h2>
      </div>
      <div id="drop_zone_log" class="span6 upload_box">
        <h2>Drop <span style="color:#4284D3;">log</span> file here!</h2>
      </div>
    </div>
    <div class="row-fluid">
      <div class="progress progress-striped active span6">
          <div id="demo_progress" class="bar" style="width: 40%;"></div>
      </div>
      <div class="progress progress-striped active span6">
         <div id="log_progress" class="bar" style="width: 40%;"></div>
      </div>
    </div>
    {#
    <div class="control-group  {% if 'name' in errors %}error{% endif %}">
      <label class="control-label" for="Íname">Demo File</label>
      <div class="controls">
        <input type="file" class="input-xlarge" id="demo_file" name="demo_file" placeholder="auto-19880905-XXXX-cp_gravelpit.dem" value="{{ values.get('name', '') }}"/>
      </div>
    </div>
    <div class="control-group  {% if 'name' in errors %}error{% endif %}">
      <label class="control-label" for="Íname">Log File</label>
      <div class="controls">
        <input type="file" class="input-xlarge" id="log_file" name="log_file" placeholder="auto-19880905-XXXX-cp_gravelpit.dem" value="{{ values.get('name', '') }}"/>
      </div>
    </div>
    #}
    <div style="text-align:center;" class="form-actions">
      <button type="submit" class="btn btn-success">Upload Demo</button>
    </div>
  </fieldset>
</form>
{% endblock %}
{% block javascript %}
<script>
  function errorHandler(evt) {
    switch(evt.target.error.code) {
      case evt.target.error.NOT_FOUND_ERR:
        alert('File Not Found!');
        break;
      case evt.target.error.NOT_READABLE_ERR:
        alert('File is not readable');
        break;
      case evt.target.error.ABORT_ERR:
        break; // noop
      default:
        alert('An error occurred reading this file.');
    };
  }
  function handleFileSelectDemo(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var f = evt.dataTransfer.files[0]; // FileList object.

    // files is a FileList of File objects. List some properties.
    var output = [];
    var fn = escape(f.name);
    var name_match = fn.match(/^auto-([0-9]{8})-.*-(.*)\.dem$/);
    if (name_match == null) {
      output.push('<h3 style="color:#BE2F33;"><i class="icon-file-alt icon"></i> ', escape(f.name), '</h3>',
                  '<h4 style="color:#000;">Oops!<br />That file didn\'t match the format I expected for a demo file:</h4>',
                  '<h4>auto<span style="color:#000;">-</span><span style="color:#8dc63f;">20130119</span>',
                  '<span style="color:#000;">-</span><span style="color:#f26c4f;">2034</span>',
                  '<span style="color:#000;">-</span><span style="color:#448ccb">',
                  'cp_dustbowl</span><span style="color:#a864a8">.dem</span><h4>',
                  '<h4 style="color:#000;">If you\'re <span style="color:#2D9B27;">sure</span>',
                  ' this is your demo file,<br />rename it and drag here again!</h4>',
                  '<a id="undo_demo" class="btn btn-info" href="#">Clear Invalid File</a>');
    } else {
      output.push('<h3 style="color:#2D9B27;"><i class="icon-file-alt icon"></i> ', escape(f.name), '</h3>',
                  '<a id="undo_demo" class="btn btn-info" href="#">Clear Demo File</a>');
    }

    document.getElementById('drop_zone_demo').innerHTML = output.join('');
  }
  function handleFileSelectLog(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object.
    var progressDemo = document.getElementById('demo_percent');
    var progressLog = document.getElementById('log_percent');

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      var fn = escape(f.name);
      var name_match = fn.match(/^.*\.log$/);
      if (name_match == null) {
        output.push('<h3 style="color:#BE2F33;"><i class="icon-file-alt icon"></i> ', escape(f.name), '</h3>',
                    '<a id="undo_" class="btn btn-danger" href="#">Try again</a>');
      } else {
        output.push('<h3 style="color:#2D9B27;"><i class="icon-file-alt icon"></i> ', escape(f.name), '</h3>',
                    '<a id="undo_log" class="btn btn-info" href="#">Clear Log File</a>');
      }
    }
    document.getElementById('drop_zone_log').innerHTML = output.join('');
  }

  $(document).on("click", "#undo_log", function () {
    $("#drop_zone_log").html("<h2>Drop <span style=\"color:#4284D3;\">log</span> file here!</h2>");
  });
  $(document).on("click", "#undo_demo", function () {
    $("#drop_zone_demo").html("<h2>Drop <span style=\"color:#FF8540;\">demo</span> file here!</h2>");
  });

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }

  // Setup the dnd listeners.
  var dropZoneDemo = document.getElementById('drop_zone_demo');
  dropZoneDemo.addEventListener('dragover', handleDragOver, false);
  dropZoneDemo.addEventListener('drop', handleFileSelectDemo, false);
  var dropZoneLog = document.getElementById('drop_zone_log');
  dropZoneLog.addEventListener('dragover', handleDragOver, false);
  dropZoneLog.addEventListener('drop', handleFileSelectLog, false);
</script>
{% endblock %}
